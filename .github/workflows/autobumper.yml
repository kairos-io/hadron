name: 'Automatic version updates'
on:
  schedule:
    # minute hour dom month dow (UTC)
    - cron: '0 22 * * *'
  # enable manual trigger of version updates
  workflow_dispatch:
jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - name: Cache Go build cache
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/go-build
            ~/go/bin
          key: go-bump-${{ runner.os }}-${{ env.GITHUB_REF_NAME }}
          restore-keys: |
            go-bump-${{ runner.os }}-
      - uses: actions/setup-go@v6
      - name: Install bump
        run: |
          go install github.com/wader/bump/cmd/bump@latest
      - name: Bump version and create PR
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Disable this var so bump does not think it's running as an action
          unset GITHUB_ACTION
          set -e
          
          # Check if fork exists, create if not
          if ! gh repo view ci-forks/hadron --json name > /dev/null 2>&1; then
            echo "Fork does not exist. Creating fork..."
            gh repo fork kairos-io/hadron --clone=false --remote=false --org ci-forks
          else
            echo "Fork already exists."
          fi

          # Clone fork using PAT for authentication
          git clone https://ci-forks:${GITHUB_TOKEN}@github.com/ci-forks/hadron.git fork
          cd fork

          # Ensure all pushes use the PAT
          git remote set-url origin https://ci-forks:${GITHUB_TOKEN}@github.com/ci-forks/hadron.git

          # Add upstream and sync main
          git remote add upstream https://github.com/kairos-io/hadron || true
          git fetch upstream
          git checkout main
          git reset --hard upstream/main
          git push origin main --force

          # Create and checkout work branch
          git checkout -B bumps

          # Run bump and commit changes
          bump update -v
          git add Dockerfile
          git config user.name "ci-robbot"
          git config user.email "robot@c3os.io"
          git commit -s -m "Bump packages" || echo "No changes to commit"
          git push origin bumps --force

          # Check if PR already exists
          PR_NUMBER=$(gh pr list --head ci-forks:bumps --base main --repo kairos-io/hadron --json number -q '.[0].number')
          if [ -n "$PR_NUMBER" ]; then
            echo "PR #$PR_NUMBER already exists. Updating title/body/labels."
            gh pr edit $PR_NUMBER --title "Automatic version bumps" --body "This PR contains automatic version bumps." --add-label "auto-bump" --repo kairos-io/hadron
          else
            echo "No PR found. Creating a new one."
            gh pr create --title "Automatic version bumps" --body "This PR contains automatic version bumps." --head ci-forks:bumps --base main --repo kairos-io/hadron --label "auto-bump"
          fi
