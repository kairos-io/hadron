#cloud-config

strict: true
debug: true

install:
  no-format: true
  auto: false
  poweroff: false
  reboot: false
  grub_options:
    extra_cmdline: "rd.immucore.debug"

users:
  - name: "kairos"
    passwd: "kairos"
    groups:
      - "admin"

stages:
  kairos-install.pre.before:
    - if:  '[ -e "/dev/vdb" ]'
      name: "Create partitions"
      commands:
        - |
          parted --script --machine -- "/dev/vdb" mklabel gpt
          # Legacy bios
          sgdisk --new=1:2048:+1M --change-name=1:'bios' --typecode=1:EF02 /dev/vdb
      layout:
        device:
          path: "/dev/vdb"
        add_partitions:
          # For efi (comment out the legacy bios partition above)
          #- fsLabel: COS_GRUB
          #  size: 64
          #  pLabel: efi
          #  filesystem: "fat"
          - fsLabel: COS_OEM
            size: 64
            pLabel: oem
          - fsLabel: COS_RECOVERY
            size: 8500
            pLabel: recovery
          - fsLabel: COS_STATE
            size: 18000
            pLabel: state
          - fsLabel: COS_PERSISTENT
            pLabel: persistent
            size: 0
            filesystem: "ext4"